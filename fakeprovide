#!/bin/sh
#
# This script will generate an RPM that "provides" a named dependency.

RPM_BUILDARCH=noarch

usage () {
	echo "$0: usage: $0 [ -a arch ] [ -s summary ] name"
}

while getopts 'a:s:h' ch; do
	case $ch in
		(a)	RPM_BUILDARCH="$OPTARG";;
		(s)	RPM_SUMMARY="$OPTARG";;
		(h)	usage
			exit 0
			;;

		(\?)	usage >&2
			exit 2
			;;
	esac
done

tmpdir=$(mktemp -d --tmpdir rpmspecXXXXXX)
trap "rm -rf $tmpdir" EXIT INT QUIT TERM HUP

provide=$1

if [ ! "$provide" ]; then
	echo "ERROR: Nothing to provide." >&2
	exit 1
fi

mkdir -p $tmpdir/rpmbuild/SOURCES
cat > $tmpdir/rpmbuild/SOURCES/README <<EOF
This package was generated by fakeprovide.

- http://github.com/larsks/fakeprovide/
EOF

cat > $tmpdir/fakeprovide.spec <<EOF
Name:		fakeprovide-$provide
Version:	$(date "+%Y%m%d%H%M%S")
Release:	1%{?dist}
Summary:	${RPM_SUMMARY:-Fake provide for $provide.}

Group:		Fake
License:	GPL
BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)

Source:		README
Provides:	$provide

BuildArch:	$RPM_BUILDARCH

%description
%{summary}

%prep


%build


%install
rm -rf $RPM_BUILD_ROOT


%clean
rm -rf $RPM_BUILD_ROOT


%files
%defattr(-,root,root,-)
%doc README



%changelog

EOF

export HOME=$tmpdir
rpmbuild -bb $tmpdir/fakeprovide.spec > $tmpdir/log 2>&1
for rpm in $tmpdir/rpmbuild/RPMS/*/*.rpm; do
	[ -f "$rpm" ] || continue

	cp "$rpm" .
	ls -l "$(basename $rpm)"
done


